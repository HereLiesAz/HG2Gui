name: Jules Auto-Merge Branch

on:
  create:

jobs:
  jules-branch-manager:
    if: github.event.ref_type == 'branch'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Invoke Jules
        uses: google-labs-code/jules-invoke@v1
        env:
          # Use GH_TOKEN repository secret as requested for authentication
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        with:
          jules_api_key: ${{ secrets.JULES_API_KEY }}
          prompt: |
            You are Jules, an AI software engineer.
            A new branch '${{ github.ref_name }}' has been created.

            Your task is to manage the lifecycle of this branch by performing the following actions:

            1.  **Create a Pull Request**: Create a PR for '${{ github.ref_name }}' targeting the default branch ('${{ github.event.repository.default_branch }}'). Use `gh pr create` with a clear title and description.
            2.  **Evaluate**: Examine the code changes in the branch. Determine if the changes are valid, necessary, and safe.
            3.  **Review**: Perform a code review. If you find issues, fix them yourself by modifying the code and pushing updates.
            4.  **Fix Suggestions**: If there are any suggestions from other reviewers (or if you identified issues in step 3), apply the fixes.
            5.  **Handle Conflicts**: Check for merge conflicts with the target branch. If conflicts exist, resolve them.
            6.  **Merge**: If the Pull Request is valid and all checks pass, merge it using `gh pr merge --merge --auto`.
            7.  **Cleanup**: After merging (or if the PR is deemed invalid and should be rejected), ensure the Pull Request is closed and the branch '${{ github.ref_name }}' is deleted.

            Use `run_in_bash_session` to execute `gh` and `git` commands.
            Ensure you verify each step (e.g., check if PR creation was successful).
